<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½QQæœºå™¨äºº - ç›‘æ§é¢æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .header .status {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            background: rgba(255,255,255,0.1);
            font-size: 0.875rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-online { background: #27ae60; }
        .status-offline { background: #e74c3c; }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #f8f9fa;
        }
        
        .tab.active {
            border-bottom-color: #3498db;
            color: #3498db;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        
        .card h3 {
            margin-bottom: 1rem;
            color: #2c3e50;
        }
        
        .log-container {
            height: 500px;
            overflow-y: auto;
            background: #0d1117;
            color: #f0f6fc;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'SFMono-Regular', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            border: 1px solid #21262d;
        }
        
        .log-entry {
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            border-left: 4px solid transparent;
            padding-left: 1rem;
            border-radius: 0 4px 4px 0;
            background: rgba(56, 139, 253, 0.05);
            transition: background 0.2s;
        }
        
        .log-entry:hover {
            background: rgba(56, 139, 253, 0.1);
        }
        
        .log-info { 
            border-left-color: #58a6ff;
            background: rgba(88, 166, 255, 0.05);
        }
        .log-warn { 
            border-left-color: #f85149;
            background: rgba(248, 81, 73, 0.05);
        }
        .log-error { 
            border-left-color: #da3633;
            background: rgba(218, 54, 51, 0.1);
        }
        .log-debug { 
            border-left-color: #8b949e;
            background: rgba(139, 148, 158, 0.05);
        }
        
        .log-timestamp {
            color: #7d8590;
            font-size: 0.8125rem;
            margin-right: 0.75rem;
        }
        
        .log-level {
            font-weight: 600;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-right: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .log-level-info {
            background: rgba(88, 166, 255, 0.2);
            color: #58a6ff;
        }
        
        .log-level-warn {
            background: rgba(248, 81, 73, 0.2);
            color: #f85149;
        }
        
        .log-level-error {
            background: rgba(218, 54, 51, 0.2);
            color: #da3633;
        }
        
        .log-level-debug {
            background: rgba(139, 148, 158, 0.2);
            color: #8b949e;
        }
        
        .log-message {
            color: #f0f6fc;
            word-wrap: break-word;
        }
        
        .log-json {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 6px;
            font-family: 'SFMono-Regular', monospace;
            font-size: 0.8125rem;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        .log-code-block {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            font-family: 'SFMono-Regular', monospace;
            font-size: 0.8125rem;
            overflow-x: auto;
            white-space: pre-wrap;
            color: #f0f6fc;
            line-height: 1.5;
        }
        
        .log-prompt {
            background: #21262d;
            border-left: 3px solid #58a6ff;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 0 6px 6px 0;
            font-style: italic;
            color: #c9d1d9;
        }
        
        .log-api-call {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.5rem;
        }
        
        .api-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #58a6ff;
            margin-bottom: 0.5rem;
        }
        
        .api-details {
            font-size: 0.8125rem;
            color: #8b949e;
            margin-bottom: 0.75rem;
        }
        
        .code-highlight {
            background: #21262d;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-family: 'SFMono-Regular', monospace;
            font-size: 0.8125rem;
        }
        
        .json-key {
            color: #79c0ff;
        }
        
        .json-string {
            color: #a5d6ff;
        }
        
        .json-number {
            color: #79c0ff;
        }
        
        .json-boolean {
            color: #ff7b72;
        }
        
        .json-null {
            color: #8b949e;
        }
        
        .json-punctuation {
            color: #f0f6fc;
        }
        
        .expandable {
            cursor: pointer;
            user-select: none;
        }
        
        .expandable::before {
            content: 'â–¶';
            display: inline-block;
            margin-right: 0.5rem;
            transition: transform 0.2s;
            color: #7d8590;
        }
        
        .expandable.expanded::before {
            transform: rotate(90deg);
        }
        
        .collapsed {
            display: none;
        }
        
        .conversation-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .conversation-item {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .conversation-item:hover {
            background: #f8f9fa;
        }
        
        .conversation-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .user-info {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .timestamp {
            color: #7f8c8d;
            font-size: 0.875rem;
        }
        
        .message-preview {
            color: #666;
            font-size: 0.875rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .message-detail {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            display: none;
        }
        
        .message-detail.active {
            display: block;
        }
        
        .message-pair {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .message-pair:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .user-message, .bot-message {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        .user-message {
            background: #e3f2fd;
            margin-left: 2rem;
        }
        
        .bot-message {
            background: #f3e5f5;
            margin-right: 2rem;
        }
        
        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            background: #3498db;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .refresh-indicator {
            width: 12px;
            height: 12px;
            border: 2px solid #3498db;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¤– æ™ºèƒ½QQæœºå™¨äºº - ç›‘æ§é¢æ¿</h1>
        <div class="status">
            <div class="status-item">
                <div class="status-dot" id="websocket-status"></div>
                WebSocket: <span id="websocket-text">è¿æ¥ä¸­...</span>
            </div>
            <div class="status-item">
                <div class="status-dot" id="ai-status"></div>
                AIæœåŠ¡: <span id="ai-text">æ£€æŸ¥ä¸­...</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="logs">ğŸ“‹ å®æ—¶æ—¥å¿—</div>
            <div class="tab" data-tab="conversations">ğŸ’¬ å¯¹è¯å†å²</div>
            <div class="tab" data-tab="whitelist">âš™ï¸ ç™½åå•ç®¡ç†</div>
        </div>

        <div id="logs" class="tab-content active">
            <div class="card">
                <div class="controls">
                    <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                    <button onclick="downloadLogs()">ä¸‹è½½æ—¥å¿—</button>
                    <div class="auto-refresh">
                        <input type="checkbox" id="auto-refresh" checked>
                        <label for="auto-refresh">è‡ªåŠ¨åˆ·æ–°</label>
                        <div class="refresh-indicator" id="refresh-indicator" style="display: none;"></div>
                    </div>
                </div>
                <div class="log-container" id="log-container">
                    <div class="log-entry log-info">ç­‰å¾…æ—¥å¿—æ•°æ®...</div>
                </div>
            </div>
        </div>

        <div id="conversations" class="tab-content">
            <div class="card">
                <h3>å¯¹è¯åˆ—è¡¨</h3>
                <div class="conversation-list" id="conversation-list">
                    <div class="conversation-item">
                        <div class="conversation-header">
                            <span class="user-info">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                </div>
                <div class="message-detail" id="message-detail"></div>
            </div>
        </div>

        <div id="whitelist" class="tab-content">
            <div class="card">
                <h3>ç™½åå•ç®¡ç†</h3>
                <div style="margin-bottom: 1rem;">
                    <span>çŠ¶æ€: </span>
                    <span id="whitelist-status">æ£€æŸ¥ä¸­...</span>
                </div>
                <div class="controls">
                    <input type="text" id="group-input" placeholder="è¾“å…¥ç¾¤å·" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    <button onclick="addGroup()">æ·»åŠ ç¾¤ç»„</button>
                    <button onclick="refreshWhitelist()">åˆ·æ–°</button>
                </div>
                <div id="whitelist-groups" style="margin-top: 1rem;">
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
                
                if (targetTab === 'conversations') {
                    loadConversations();
                } else if (targetTab === 'whitelist') {
                    loadWhitelist();
                }
            });
        });

        let logs = [];
        let autoRefresh = true;
        
        // è·å–çŠ¶æ€
        async function fetchStatus() {
            try {
                const response = await fetch('/ws/status');
                const data = await response.json();
                
                const wsStatus = document.getElementById('websocket-status');
                const wsText = document.getElementById('websocket-text');
                const aiStatus = document.getElementById('ai-status');
                const aiText = document.getElementById('ai-text');
                
                if (data.connected) {
                    wsStatus.className = 'status-dot status-online';
                    wsText.textContent = 'å·²è¿æ¥';
                } else {
                    wsStatus.className = 'status-dot status-offline';
                    wsText.textContent = 'æœªè¿æ¥';
                }
                
                if (data.ai_ready) {
                    aiStatus.className = 'status-dot status-online';
                    aiText.textContent = 'æ­£å¸¸';
                } else {
                    aiStatus.className = 'status-dot status-offline';
                    aiText.textContent = 'å¼‚å¸¸';
                }
            } catch (error) {
                console.error('è·å–çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ—¥å¿—
        async function loadLogs() {
            if (!autoRefresh) return;
            
            try {
                const indicator = document.getElementById('refresh-indicator');
                indicator.style.display = 'block';
                
                const response = await fetch('/api/logs?limit=100');
                const data = await response.json();
                
                if (data.success && data.logs) {
                    displayLogs(data.logs);
                }
                
                indicator.style.display = 'none';
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
                document.getElementById('refresh-indicator').style.display = 'none';
            }
        }

        function displayLogs(newLogs) {
            const container = document.getElementById('log-container');
            container.innerHTML = '';
            
            newLogs.forEach((log, index) => {
                const entry = document.createElement('div');
                entry.className = `log-entry log-${log.level}`;
                
                const timestamp = new Date(log.timestamp).toLocaleString();
                const logId = `log-${index}`;
                
                // åˆ†ç¦»ä¸»è¦æ¶ˆæ¯å’ŒJSONæ•°æ®
                let mainMessage = log.message;
                let jsonData = null;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰JSONæ•°æ®
                if (log.meta && typeof log.meta === 'object') {
                    jsonData = log.meta;
                } else {
                    // å°è¯•ä»æ¶ˆæ¯ä¸­æå–JSON
                    const jsonMatch = log.message.match(/^(.*?)\s*\|\s*(\{.*\})$/s);
                    if (jsonMatch) {
                        mainMessage = jsonMatch[1].trim();
                        try {
                            jsonData = JSON.parse(jsonMatch[2]);
                        } catch (e) {
                            // å¦‚æœè§£æå¤±è´¥ï¼Œä¿æŒåŸæ ·
                        }
                    }
                }
                
                // æ£€æµ‹ç‰¹æ®Šç±»å‹çš„æ—¥å¿—å¹¶ç¾åŒ–
                const specialFormatted = formatSpecialLog(mainMessage, jsonData, logId);
                if (specialFormatted) {
                    entry.innerHTML = `
                        <div>
                            <span class="log-timestamp">${timestamp}</span>
                            <span class="log-level log-level-${log.level}">${log.level}</span>
                        </div>
                        ${specialFormatted}
                    `;
                } else {
                    let entryHTML = `
                        <div>
                            <span class="log-timestamp">${timestamp}</span>
                            <span class="log-level log-level-${log.level}">${log.level}</span>
                            <span class="log-message">${escapeHtml(mainMessage)}</span>
                        </div>
                    `;
                    
                    if (jsonData) {
                        entryHTML += `
                            <div class="expandable" onclick="toggleJsonExpand('${logId}')">
                                JSONæ•°æ® (${Object.keys(jsonData).length} å­—æ®µ)
                            </div>
                            <div id="${logId}" class="log-json collapsed">
                                ${formatJson(jsonData)}
                            </div>
                        `;
                    }
                    
                    entry.innerHTML = entryHTML;
                }
                
                container.appendChild(entry);
            });
            
            // container.scrollTop = container.scrollHeight;
        }
        
        function formatSpecialLog(message, jsonData, logId) {
            // æ£€æµ‹APIè°ƒç”¨æ—¥å¿—
            if (message.includes('ğŸ¤– è°ƒç”¨Gemini API') || message.includes('âœ… Gemini APIå“åº”æˆåŠŸ')) {
                return formatApiCallLog(message, jsonData, logId);
            }
            
            // æ£€æµ‹QQæ¶ˆæ¯æ—¥å¿—
            if (message.includes('ğŸ“¨ æ”¶åˆ°ç¾¤èŠæ¶ˆæ¯') || message.includes('ğŸ’¬ æ”¶åˆ°ç§èŠæ¶ˆæ¯')) {
                return formatQQMessageLog(message, jsonData, logId);
            }
            
            // æ£€æµ‹WebSocketè¿æ¥æ—¥å¿—
            if (message.includes('WebSocket') || message.includes('è¿æ¥')) {
                return formatConnectionLog(message, jsonData, logId);
            }
            
            return null;
        }
        
        function formatApiCallLog(message, jsonData, logId) {
            const isResponse = message.includes('å“åº”æˆåŠŸ');
            const icon = isResponse ? 'âœ…' : 'ğŸ¤–';
            const title = isResponse ? 'Gemini API å“åº”' : 'Gemini API è°ƒç”¨';
            
            let content = `
                <div class="log-api-call">
                    <div class="api-header">
                        <span>${icon}</span>
                        <span>${title}</span>
                    </div>
            `;
            
            if (jsonData) {
                if (jsonData.model) {
                    content += `<div class="api-details">æ¨¡å‹: <span class="code-highlight">${jsonData.model}</span></div>`;
                }
                
                if (jsonData.promptLength) {
                    content += `<div class="api-details">Prompté•¿åº¦: <span class="code-highlight">${jsonData.promptLength}</span> å­—ç¬¦</div>`;
                }
                
                if (jsonData.responseLength) {
                    content += `<div class="api-details">å“åº”é•¿åº¦: <span class="code-highlight">${jsonData.responseLength}</span> å­—ç¬¦</div>`;
                }
                
                if (jsonData.tokensUsed) {
                    content += `<div class="api-details">Tokenä½¿ç”¨: <span class="code-highlight">${jsonData.tokensUsed}</span></div>`;
                }
                
                if (jsonData.prompt) {
                    const promptPreview = jsonData.prompt.length > 200 ? 
                        jsonData.prompt.substring(0, 200) + '...' : jsonData.prompt;
                    
                    content += `
                        <div class="expandable" onclick="toggleJsonExpand('${logId}-prompt')">
                            ğŸ“ æŸ¥çœ‹Promptå†…å®¹
                        </div>
                        <div id="${logId}-prompt" class="log-prompt collapsed">
                            ${formatPromptContent(jsonData.prompt)}
                        </div>
                    `;
                }
                
                if (jsonData.response) {
                    const responsePreview = jsonData.response.length > 200 ? 
                        jsonData.response.substring(0, 200) + '...' : jsonData.response;
                    
                    content += `
                        <div class="expandable" onclick="toggleJsonExpand('${logId}-response')">
                            ğŸ’¬ æŸ¥çœ‹å“åº”å†…å®¹
                        </div>
                        <div id="${logId}-response" class="log-code-block collapsed">
                            ${escapeHtml(jsonData.response)}
                        </div>
                    `;
                }
                
                // æ˜¾ç¤ºå®Œæ•´JSONæ•°æ®
                content += `
                    <div class="expandable" onclick="toggleJsonExpand('${logId}-json')">
                        ğŸ”§ æŸ¥çœ‹å®Œæ•´æ•°æ®
                    </div>
                    <div id="${logId}-json" class="log-json collapsed">
                        ${formatJson(jsonData)}
                    </div>
                `;
            }
            
            content += '</div>';
            return content;
        }
        
        function formatQQMessageLog(message, jsonData, logId) {
            const isGroup = message.includes('ç¾¤èŠ');
            const icon = isGroup ? 'ğŸ“¨' : 'ğŸ’¬';
            
            return `
                <div class="log-message">
                    <span>${icon}</span> ${escapeHtml(message)}
                </div>
                ${jsonData ? `
                    <div class="expandable" onclick="toggleJsonExpand('${logId}')">
                        ğŸ“‹ æ¶ˆæ¯è¯¦æƒ…
                    </div>
                    <div id="${logId}" class="log-json collapsed">
                        ${formatJson(jsonData)}
                    </div>
                ` : ''}
            `;
        }
        
        function formatConnectionLog(message, jsonData, logId) {
            return `
                <div class="log-message">
                    <span>ğŸ”Œ</span> ${escapeHtml(message)}
                </div>
                ${jsonData ? `
                    <div class="expandable" onclick="toggleJsonExpand('${logId}')">
                        ğŸ”§ è¿æ¥è¯¦æƒ…
                    </div>
                    <div id="${logId}" class="log-json collapsed">
                        ${formatJson(jsonData)}
                    </div>
                ` : ''}
            `;
        }
        
        function formatPromptContent(prompt) {
            // æ ¼å¼åŒ–Promptå†…å®¹ï¼Œå¤„ç†æ¢è¡Œå’Œç»“æ„
            let formatted = escapeHtml(prompt);
            
            // é«˜äº®ç³»ç»Ÿæç¤º
            formatted = formatted.replace(
                /(ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½ç¾¤èŠåŠ©æ‰‹ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š[\s\S]*?- åœ¨ç¾¤èŠä¸­ä¿æŒé€‚å½“çš„æ´»è·ƒåº¦)/,
                '<div style="color: #79c0ff; font-weight: 600;">$1</div>'
            );
            
            // é«˜äº®å¯¹è¯å†å²éƒ¨åˆ†
            formatted = formatted.replace(
                /(æœ€è¿‘çš„å¯¹è¯å†å²ï¼š[\s\S]*?)(\n\nç”¨æˆ·æ¶ˆæ¯ï¼š)/,
                '<div style="color: #f85149; font-weight: 600;">å¯¹è¯å†å²:</div><div style="background: #21262d; padding: 0.5rem; margin: 0.5rem 0; border-radius: 4px;">$1</div>$2'
            );
            
            // é«˜äº®ç”¨æˆ·æ¶ˆæ¯
            formatted = formatted.replace(
                /(ç”¨æˆ·æ¶ˆæ¯ï¼š)(.*?)(\n\nè¯·å›å¤ï¼š)/,
                '<div style="color: #a5d6ff; font-weight: 600;">$1</div><div style="background: #161b22; padding: 0.5rem; margin: 0.5rem 0; border-radius: 4px; color: #f0f6fc;">$2</div><div style="color: #ff7b72; font-weight: 600;">è¯·å›å¤ï¼š</div>'
            );
            
            return formatted;
        }
        
        function formatJson(obj, indent = 0) {
            const spaces = '  '.repeat(indent);
            
            if (obj === null) {
                return '<span class="json-null">null</span>';
            }
            
            if (typeof obj === 'string') {
                return `<span class="json-string">"${escapeHtml(obj)}"</span>`;
            }
            
            if (typeof obj === 'number') {
                return `<span class="json-number">${obj}</span>`;
            }
            
            if (typeof obj === 'boolean') {
                return `<span class="json-boolean">${obj}</span>`;
            }
            
            if (Array.isArray(obj)) {
                if (obj.length === 0) {
                    return '<span class="json-punctuation">[]</span>';
                }
                
                let result = '<span class="json-punctuation">[</span>\n';
                obj.forEach((item, index) => {
                    result += spaces + '  ' + formatJson(item, indent + 1);
                    if (index < obj.length - 1) {
                        result += '<span class="json-punctuation">,</span>';
                    }
                    result += '\n';
                });
                result += spaces + '<span class="json-punctuation">]</span>';
                return result;
            }
            
            if (typeof obj === 'object') {
                const keys = Object.keys(obj);
                if (keys.length === 0) {
                    return '<span class="json-punctuation">{}</span>';
                }
                
                // ç¬¬ä¸€è¡Œçš„å¤§æ‹¬å·ä¸æ¢è¡Œï¼Œç´§è·Ÿåœ¨å‰é¢
                let result = '<span class="json-punctuation">{</span>';
                keys.forEach((key, index) => {
                    result += '\n' + spaces + '  ';
                    result += `<span class="json-key">"${escapeHtml(key)}"</span>`;
                    result += '<span class="json-punctuation">: </span>';
                    result += formatJson(obj[key], indent + 1);
                    if (index < keys.length - 1) {
                        result += '<span class="json-punctuation">,</span>';
                    }
                });
                result += '\n' + spaces + '<span class="json-punctuation">}</span>';
                return result;
            }
            
            return escapeHtml(String(obj));
        }
        
        function toggleJsonExpand(logId) {
            const element = document.getElementById(logId);
            const trigger = element.previousElementSibling;
            
            if (element.classList.contains('collapsed')) {
                element.classList.remove('collapsed');
                trigger.classList.add('expanded');
            } else {
                element.classList.add('collapsed');
                trigger.classList.remove('expanded');
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åŠ è½½å¯¹è¯å†å²
        async function loadConversations() {
            try {
                const response = await fetch('/api/conversations');
                const data = await response.json();
                
                if (data.success) {
                    displayConversations(data.conversations);
                }
            } catch (error) {
                console.error('åŠ è½½å¯¹è¯å¤±è´¥:', error);
            }
        }

        function displayConversations(conversations) {
            const container = document.getElementById('conversation-list');
            container.innerHTML = '';
            
            if (conversations.length === 0) {
                container.innerHTML = '<div class="conversation-item"><div class="conversation-header"><span class="user-info">æš‚æ— å¯¹è¯å†å²</span></div></div>';
                return;
            }
            
            conversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                item.onclick = () => showConversationDetail(conv);
                
                const lastMessage = conv.messages[conv.messages.length - 1];
                const firstUserMessage = conv.messages.find(msg => msg.userId !== 'assistant');
                const displayName = firstUserMessage?.userName || `ç”¨æˆ·${conv.userId}`;
                
                // æ‰¾åˆ°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºé¢„è§ˆ
                let previewMessage = lastMessage;
                if (lastMessage.userId === 'assistant') {
                    // å¦‚æœæœ€åä¸€æ¡æ˜¯AIå›å¤ï¼Œæ‰¾åˆ°å€’æ•°ç¬¬äºŒæ¡ç”¨æˆ·æ¶ˆæ¯
                    for (let i = conv.messages.length - 2; i >= 0; i--) {
                        if (conv.messages[i].userId !== 'assistant') {
                            previewMessage = conv.messages[i];
                            break;
                        }
                    }
                }
                
                item.innerHTML = `
                    <div class="conversation-header">
                        <span class="user-info">
                            ${conv.groupId ? `ç¾¤èŠ ${conv.groupId}` : 'ç§èŠ'} - ${escapeHtml(displayName)}
                        </span>
                        <span class="timestamp">${new Date(lastMessage.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="message-preview">${escapeHtml(previewMessage.content.substring(0, 100))}${previewMessage.content.length > 100 ? '...' : ''}</div>
                `;
                
                container.appendChild(item);
            });
        }

        function showConversationDetail(conversation) {
            const detail = document.getElementById('message-detail');
            detail.innerHTML = '';
            
            // æŒ‰æ—¶é—´é¡ºåºåˆ†ç»„ç”¨æˆ·æ¶ˆæ¯å’ŒAIå›å¤
            const messages = conversation.messages;
            let currentPair = null;
            
            messages.forEach(msg => {
                if (msg.userId === 'assistant') {
                    // AIå›å¤æ¶ˆæ¯
                    if (currentPair) {
                        const botMsg = document.createElement('div');
                        botMsg.className = 'bot-message';
                        botMsg.innerHTML = `
                            <strong>æœºå™¨äºº:</strong> ${escapeHtml(msg.content)}<br>
                            <small>${new Date(msg.timestamp).toLocaleString()}</small>
                        `;
                        currentPair.appendChild(botMsg);
                        detail.appendChild(currentPair);
                        currentPair = null;
                    }
                } else {
                    // ç”¨æˆ·æ¶ˆæ¯
                    if (currentPair) {
                        detail.appendChild(currentPair);
                    }
                    
                    currentPair = document.createElement('div');
                    currentPair.className = 'message-pair';
                    
                    const userMsg = document.createElement('div');
                    userMsg.className = 'user-message';
                    const displayName = msg.userName || `ç”¨æˆ·${msg.userId}`;
                    userMsg.innerHTML = `
                        <strong>${escapeHtml(displayName)}:</strong> ${escapeHtml(msg.content)}<br>
                        <small>${new Date(msg.timestamp).toLocaleString()}</small>
                    `;
                    
                    currentPair.appendChild(userMsg);
                }
            });
            
            // æ·»åŠ æœ€åä¸€ä¸ªæœªå®Œæˆçš„å¯¹è¯å¯¹
            if (currentPair) {
                detail.appendChild(currentPair);
            }
            
            detail.classList.add('active');
        }

        // ç™½åå•ç®¡ç†
        async function loadWhitelist() {
            try {
                const response = await fetch('/whitelist/status');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('whitelist-status').textContent = 
                        data.data.enabled ? `å·²å¯ç”¨ (${data.data.groupCount}ä¸ªç¾¤ç»„)` : 'æœªå¯ç”¨';
                    
                    const groupsHtml = data.data.groups.length > 0 
                        ? data.data.groups.map(group => `
                            <div style="display: flex; justify-content: between; align-items: center; padding: 0.5rem; border: 1px solid #ddd; margin-bottom: 0.5rem; border-radius: 4px;">
                                <span>ç¾¤ç»„: ${group}</span>
                                <button onclick="removeGroup('${group}')" style="background: #e74c3c;">ç§»é™¤</button>
                            </div>
                        `).join('')
                        : '<p>æš‚æ— ç™½åå•ç¾¤ç»„</p>';
                    
                    document.getElementById('whitelist-groups').innerHTML = groupsHtml;
                }
            } catch (error) {
                console.error('åŠ è½½ç™½åå•å¤±è´¥:', error);
            }
        }

        async function addGroup() {
            const input = document.getElementById('group-input');
            const groupId = input.value.trim();
            
            if (!groupId) return;
            
            try {
                const response = await fetch('/whitelist/groups', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ groups: [groupId] })
                });
                
                const data = await response.json();
                if (data.success) {
                    input.value = '';
                    loadWhitelist();
                }
            } catch (error) {
                console.error('æ·»åŠ ç¾¤ç»„å¤±è´¥:', error);
            }
        }

        async function removeGroup(groupId) {
            try {
                const response = await fetch('/whitelist/groups', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ groups: [groupId] })
                });
                
                const data = await response.json();
                if (data.success) {
                    loadWhitelist();
                }
            } catch (error) {
                console.error('ç§»é™¤ç¾¤ç»„å¤±è´¥:', error);
            }
        }

        function refreshWhitelist() {
            loadWhitelist();
        }

        // æ—¥å¿—æ§åˆ¶
        function clearLogs() {
            document.getElementById('log-container').innerHTML = 
                '<div class="log-entry log-info">æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        function downloadLogs() {
            const logs = document.getElementById('log-container').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `logs-${new Date().toISOString().slice(0, 10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        document.getElementById('auto-refresh').addEventListener('change', (e) => {
            autoRefresh = e.target.checked;
        });

        // å®šæ—¶åˆ·æ–°
        setInterval(() => {
            fetchStatus();
            if (document.querySelector('.tab[data-tab="logs"]').classList.contains('active')) {
                loadLogs();
            }
        }, 3000);

        // åˆå§‹åŠ è½½
        fetchStatus();
        loadLogs();
    </script>
</body>
</html>